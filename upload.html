<script>
const params = new URLSearchParams(window.location.search);
const expenseId = params.get('expense_id');
const token = params.get('token');

const btn = document.getElementById('submitBtn');
const fileInput = document.getElementById('files');

btn.onclick = async () => {
  if (!expenseId || !token) {
    alert('Invalid or expired link.');
    return;
  }

  if (!fileInput.files.length) {
    alert('Please select at least one file.');
    return;
  }

  btn.disabled = true;
  btn.innerText = 'Uploading...';

  const formData = new FormData();
  formData.append('expense_id', expenseId);
  formData.append('token', token);

  for (const file of fileInput.files) {
    formData.append('files', file);
  }

  try {
    const res = await fetch(
      'https://aawcr1400.app.n8n.cloud/webhook/invoice-upload',
      {
        method: 'POST',
        body: formData
      }
    );

    if (!res.ok) throw new Error('Upload failed');

    document.getElementById('successMsg').style.display = 'block';
    btn.innerText = 'Done';
  } catch (e) {
    alert('Upload failed. Please try again.');
    btn.disabled = false;
    btn.innerText = 'Submit Invoices';
  }
};
</script>
