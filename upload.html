<script>
const params = new URLSearchParams(window.location.search);
const expenseId = params.get('expense_id');
const token = params.get('token');

document.getElementById('expenseId').innerText = expenseId || 'â€”';

const btn = document.getElementById('submitBtn');

btn.onclick = async () => {
  const files = document.getElementById('files').files;

  if (!files.length) {
    alert('Please upload at least one file.');
    return;
  }

  const formData = new FormData();
  formData.append('expense_id', expenseId);
  formData.append('token', token);

  for (const f of files) {
    formData.append('files', f);
  }

  btn.disabled = true;
  btn.innerText = 'Uploading...';

  try {
    const res = await fetch(
      'https://aawcr1400.app.n8n.cloud/webhook/invoice-upload',
      {
        method: 'POST',
        body: formData
      }
    );

    if (!res.ok) throw new Error('Upload failed');

    document.getElementById('successMsg').style.display = 'block';
    btn.innerText = 'Done';
  } catch (e) {
    alert('Upload failed. Please try again.');
    btn.disabled = false;
    btn.innerText = 'Submit Invoice';
  }
};
</script>
